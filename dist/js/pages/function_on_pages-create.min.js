"use strict";class FileUploader{constructor(e){this.inputId=e.inputId,this.wrapperClass=e.wrapperClass,this.checkImageSize=!1!==e.checkImageSize,this.checkImageSize&&(this.minWidth=e.minWidth||800,this.minHeight=e.minHeight||800),this.input=document.querySelector("#"+this.inputId),this.wrapper=document.querySelector("."+this.wrapperClass),this.errorContainer=this.wrapper,this.renderContainer=document.querySelector("document"===this.inputId?"[data-render-document]":"[data-render-plan]"),this.validDocuments=[],this.invalidDocuments=[],this.input&&this.wrapper&&this.errorContainer?this.init():console.error("Не удалось найти необходимые DOM-элементы")}init(){this.input.addEventListener("change",e=>this.handleFileUpload(e))}clearErrors(){if(!this.wrapper||!this.errorContainer)return;this.wrapper.classList.remove("error"),this.wrapper.style.marginBottom="";this.errorContainer.querySelectorAll("ul.error-list, li.error").forEach(e=>e.remove())}displayErrors(){if(this.wrapper&&this.errorContainer&&(this.clearErrors(),this.invalidDocuments.length>0)){this.wrapper.classList.add("error"),this.wrapper.style.marginBottom=16*this.invalidDocuments.length+"px";const e=document.createElement("ul");e.classList.add("error-list"),this.invalidDocuments.forEach(t=>{const o=document.createElement("li");o.textContent=t.text,o.classList.add("error"),e.appendChild(o)}),this.errorContainer.appendChild(e)}}handleFileUpload(e){const t=Array.from(e.target.files);this.validDocuments=[],this.invalidDocuments=[],t.forEach((e,o)=>{"application/pdf"===e.type?this.handlePDF(e):e.type.match("image.*")?this.handleImage(e,o,t.length):this.handleInvalidFile(e)}),t.every(e=>"application/pdf"===e.type)&&(this.displayErrors(),this.render())}handlePDF(e){this.validDocuments.push({id:this.validDocuments.length,name:e.name,size:e.size,width:null,height:null})}handleImage(e,t,o){const i=new Image,n=URL.createObjectURL(e);i.onload=()=>{URL.revokeObjectURL(n);const s=i.width,r=i.height;this.checkImageSize?s>=this.minWidth&&r>=this.minHeight?this.validDocuments.push({id:this.validDocuments.length,name:e.name,size:e.size,width:s,height:r}):this.invalidDocuments.push({text:`Изображение "${e.name}" (${s}x${r}) маловатое. Минимальный размер: ${this.minWidth}x${this.minHeight} пікселів.`}):this.validDocuments.push({id:this.validDocuments.length,name:e.name,size:e.size,width:s,height:r}),t===o-1&&(this.displayErrors(),this.render())},i.onerror=()=>{URL.revokeObjectURL(n),this.invalidDocuments.push({text:"Ошибка загрузки изображения: "+e.name}),this.displayErrors()},i.src=n}handleInvalidFile(e){this.invalidDocuments.push({text:`Файл "${e.name}" не является изображением или PDF. Допустимы только изображения (JPG/PNG) и PDF.`})}render(){this.renderContainer&&(this.renderContainer.innerHTML="",this.validDocuments.forEach(e=>{const t=document.createElement("div");t.className="badge rounded-pill document-item","plan"===this.inputId?t.setAttribute("data-plan-id",e.id):t.setAttribute("data-document-id",e.id);const o=e.name.toLowerCase().endsWith(".pdf"),i=o?"iframe":"image",n=URL.createObjectURL(this.getFileByName(e.name));t.innerHTML=`\n                <span>${e.name}</span>\n                <button type="button" class="fancybox-button" data-fancybox data-type="${i}" data-src="${n}" aria-label="eye" data-id="${e.id}">\n                  <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 16 16" fill="none">\n                    <path d="M14.5 8C14.5 8 11.6 12 8 12C4.4 12 1.5 8 1.5 8C1.5 8 4.4 4 8 4C11.6 4 14.5 8 14.5 8Z"\n                      stroke="#111111" stroke-width="1.5" stroke-miterlimit="10" stroke-linejoin="round"/>\n                    <path d="M8 10C9.10457 10 10 9.10457 10 8C10 6.89543 9.10457 6 8 6C6.89543 6 6 6.89543 6 8C6 9.10457 6.89543 10 8 10Z"\n                      stroke="#111111" stroke-width="1.5" stroke-miterlimit="10" stroke-linejoin="round"/>\n                  </svg>\n                </button>\n                <button type="button" aria-label="Close" class="remove-document" data-id="${e.id}">\n                  <svg width="10" height="10" viewBox="0 0 10 10" fill="none" xmlns="http://www.w3.org/2000/svg">\n                    <path d="M0.932895 9.93359C0.708205 9.93359 0.483405 9.84787 0.311951 9.67641C-0.0310669 9.3334 -0.0310669 8.77754 0.311951 8.43452L8.43461 0.311868C8.77763 -0.0310395 9.33348 -0.0310395 9.67649 0.311868C10.0194 0.654776 10.0194 1.21074 9.67649 1.55365L1.55384 9.6763C1.38239 9.84787 1.15759 9.93359 0.932895 9.93359Z"\n                      fill="#111111"/>\n                    <path d="M9.05555 9.93348C8.83075 9.93348 8.60606 9.84776 8.43461 9.6763L0.311951 1.55365C-0.0310669 1.21074 -0.0310669 0.654776 0.311951 0.311868C0.654859 -0.0310395 1.21082 -0.0310395 1.55373 0.311868L9.67638 8.43452C10.0193 8.77754 10.0193 9.3334 9.67638 9.67641C9.50504 9.84776 9.28035 9.93348 9.05555 9.93348Z"\n                      fill="#111111"/>\n                  </svg>\n                </button>\n            `,this.renderContainer.appendChild(t)}),this.addRemoveHandlers(),this.initFancybox())}addRemoveHandlers(){this.renderContainer.querySelectorAll(".remove-document").forEach(e=>{e.addEventListener("click",t=>{t.preventDefault();const o=parseInt(e.getAttribute("data-id"));this.removeDocument(o)})})}removeDocument(e){this.validDocuments=this.validDocuments.filter(t=>t.id!==e),this.validDocuments.forEach((e,t)=>{e.id=t}),this.render()}getFileByName(e){return Array.from(this.input.files).find(t=>t.name===e)}initFancybox(){Fancybox.bind("[data-fancybox]",{Thumbs:!1,Toolbar:!0,Images:{zoom:!0}})}}class PhotoLoader{constructor(e){if(!e.inputId)throw new Error("Необходимо указать inputId");this.inputId=e.inputId,this.wrapperClass=e.wrapperClass||"photo-info-list",this.checkImageSize=!1!==e.checkImageSize,this.minWidth=e.minWidth||800,this.minHeight=e.minHeight||800,this.maxPhotos=e.maxPhotos||1/0,this.input=document.querySelector("#"+this.inputId),this.wrapper=document.querySelector("."+this.wrapperClass),this.errorContainer=document.querySelector(".photo-info-list-wrapper > .error-container"),this.renderContainer=document.querySelector(".photo-info-list"),this.validPhotos=[],this.invalidPhotos=[],this.photoArray=[],this.tooltips=new Map,this.isProcessing=!1,this.globalLoader=null,this.imageEditor=null,this.input&&this.wrapper?(this.createGlobalLoader(),this.init()):console.error("Не удалось найти необходимые DOM-элементы")}createGlobalLoader(){this.globalLoader=document.createElement("div"),this.globalLoader.className="photo-loader-global",this.globalLoader.innerHTML='\n            <div class="photo-loader-content">\n                <div class="photo-loader-spinner"></div>\n                <div class="photo-loader-text">Загрузка фото...</div>\n                <div class="photo-loader-progress">0%</div>\n            </div>\n        ',document.body.appendChild(this.globalLoader),this.globalLoader.style.display="none"}showLoader(){this.globalLoader&&(this.globalLoader.style.display="flex")}initSortable(){this.renderContainer&&"undefined"!=typeof Sortable&&new Sortable(this.renderContainer,{animation:150,ghostClass:"sortable-ghost",chosenClass:"sortable-chosen",dragClass:"sortable-drag",handle:".btn-move",onEnd:e=>this.handleSortEnd(e)})}handleSortEnd(e){const t=this.photoArray[e.oldIndex];this.photoArray.splice(e.oldIndex,1),this.photoArray.splice(e.newIndex,0,t),this.render()}hideLoader(){this.globalLoader&&(this.globalLoader.style.display="none")}updateProgress(e,t){if(!this.globalLoader)return;const o=Math.round(e/t*100),i=this.globalLoader.querySelector(".photo-loader-progress");i&&(i.textContent=o+"%")}init(){this.input.addEventListener("change",async e=>{if(!this.isProcessing){this.isProcessing=!0,this.wrapper.classList.add("loading"),this.showLoader();try{let t=0;const o=e.target.files.length,i=()=>{t++,this.updateProgress(t,o)};await this.handleFileUpload(e,i)}catch(e){console.error("Ошибка загрузки файлов:",e)}finally{this.isProcessing=!1,this.wrapper.classList.remove("loading"),this.hideLoader(),this.updateProgress(0,1)}}})}async handleFileUpload(e,t){const o=Array.from(e.target.files);if(this.photoArray.length+o.length>this.maxPhotos)return this.invalidPhotos.push({text:`Максимальное количество фото - ${this.maxPhotos}. Добавлено не будет.`}),void this.displayErrors();const i=o.map(e=>new Promise(o=>{e.type.match("image.*")||e.name.toLowerCase().endsWith(".heic")||e.name.toLowerCase().endsWith(".heif")?this.handleImage(e).then(()=>{t(),o()}).catch(e=>{console.error("Ошибка обработки изображения:",e),t(),o()}):(this.handleInvalidFile(e),t(),o())}));await Promise.all(i),this.displayResults()}handleImage(e){return new Promise((t,o)=>{("image/heic"===e.type||"image/heif"===e.type||e.name.toLowerCase().endsWith(".heic")||e.name.toLowerCase().endsWith(".heif"))&&"undefined"!=typeof heic2any?this.convertHeicToJpg(e).then(e=>this.processImageFile(e,t,o)).catch(o):this.processImageFile(e,t,o)})}convertHeicToJpg(e){return new Promise((t,o)=>{heic2any({blob:e,toType:"image/jpeg",quality:.8}).then(o=>{const i=new File([o],e.name.replace(/\.(heic|heif)$/i,".jpg"),{type:"image/jpeg",lastModified:Date.now()});t(i)}).catch(o)})}processImageFile(e,t,o){const i=new Image,n=URL.createObjectURL(e);i.onerror=()=>{URL.revokeObjectURL(n),this.invalidPhotos.push({text:"Ошибка загрузки изображения: "+e.name,file:e}),o(new Error("Ошибка загрузки изображения: "+e.name))},i.onload=()=>{URL.revokeObjectURL(n);try{const n=i.naturalWidth,s=i.naturalHeight;if(!this.checkImageSize||n>=this.minWidth&&s>=this.minHeight){const i={id:this.generateUniqueId(),name:e.name,size:e.size,width:n,height:s,file:e,isCheked:!0,objectUrl:null,originalFileType:e.type};!this.checkImageSize&&(n<this.minWidth||s<this.minHeight)?this.resizeImageToMinimum(e,i).then(e=>{this.validPhotos.push(e),this.photoArray.push(e),t()}).catch(t=>{console.error("Ошибка при изменении размера изображения:",t),this.invalidPhotos.push({text:"Ошибка обработки изображения: "+e.name,file:e}),o(t)}):(this.validPhotos.push(i),this.photoArray.push(i),t())}else this.invalidPhotos.push({text:`Изображение "${e.name}" (${n}x${s}) маловатое. Минимальный размер: ${this.minWidth}x${this.minHeight} пикселей.`,file:e}),t()}catch(t){console.error("Ошибка обработки изображения:",t),this.invalidPhotos.push({text:"Ошибка обработки изображения: "+e.name,file:e}),o(t)}},i.src=n}generateUniqueId(){return Date.now().toString(36)+Math.random().toString(36).substr(2)}handleInvalidFile(e){this.invalidPhotos.push({text:`Файл "${e.name}" не является изображением. Допустимы только изображения (JPG/PNG/HEIC/HEIF).`,file:e})}displayResults(){this.displayErrors(),this.render()}clearOldObjectUrls(){this.photoArray.forEach(e=>{e.objectUrl&&(URL.revokeObjectURL(e.objectUrl),e.objectUrl=null)})}clearErrors(){if(!this.wrapper||!this.errorContainer)return;this.wrapper.classList.remove("error");this.errorContainer.querySelectorAll(".error").forEach(e=>e.remove())}displayErrors(){this.wrapper&&this.errorContainer&&(this.clearErrors(),this.invalidPhotos.length>0&&(this.wrapper.classList.add("error"),this.invalidPhotos.forEach(e=>{const t=document.createElement("div");t.textContent=e.text,t.classList.add("error"),this.errorContainer.appendChild(t)})))}render(){if(!this.renderContainer)return;this.destroyAllTooltips();const e=this.renderContainer.querySelector(".photo-info-btn-wrapper"),t=document.createDocumentFragment();this.photoArray.forEach(e=>{e.objectUrl=URL.createObjectURL(e.file);const o=this.createPhotoElement(e);t.appendChild(o)});const o=document.createElement("ul");o.className=this.renderContainer.className,o.appendChild(t),e&&o.appendChild(e);this.renderContainer.parentNode.replaceChild(o,this.renderContainer),this.renderContainer=o,this.initTooltips(),this.initFancybox(),this.initEventHandlers(),this.initSortable()}createSpinnerElement(){const e=document.createElement("div");e.className="spinner-border text-primary",e.style.width="50px",e.style.height="50px",e.setAttribute("role","status");const t=document.createElement("span");return t.className="visually-hidden",t.textContent="Загрузка...",e.appendChild(t),e}createPhotoElement(e){const t=document.createElement("li");t.classList.add("photo-info-item"),t.setAttribute("data-photo-id",e.id);const o=this.createSpinnerElement();t.innerHTML=`\n            <label>\n                <input type="checkbox" ${e.isCheked?"checked":""}\n                       data-cheked-photo-id="${e.id}">\n                <div class="image-container">\n                </div>\n            </label>\n            <div class="photo-info-item-actions">\n                <button type="button" class="btn-see" aria-label="eye"\n                        data-fancybox data-src="${e.objectUrl}">\n                    <svg width="16" height="16" viewBox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg">\n                        <path d="M14.5 8C14.5 8 11.6 12 8 12C4.4 12 1.5 8 1.5 8C1.5 8 4.4 4 8 4C11.6 4 14.5 8 14.5 8Z" stroke="#3585F5" stroke-width="1.5" stroke-miterlimit="10" stroke-linejoin="round" />\n                        <path d="M8 10C9.10457 10 10 9.10457 10 8C10 6.89543 9.10457 6 8 6C6.89543 6 6 6.89543 6 8C6 9.10457 6.89543 10 8 10Z" stroke="#3585F5" stroke-width="1.5" stroke-miterlimit="10" stroke-linejoin="round" />\n                    </svg>\n                </button>\n                <button type="button" class="btn-move" data-move-id="${e.id}">\n                    <svg width="16" height="16" viewBox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg">\n                        <g clip-path="url(#clip0_388_3868)">\n                            <path d="M3.33301 6L1.33301 8L3.33301 10" stroke="#3585F5" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round" />\n                            <path d="M6 3.33301L8 1.33301L10 3.33301" stroke="#3585F5" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round" />\n                            <path d="M10 12.667L8 14.667L6 12.667" stroke="#3585F5" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round" />\n                            <path d="M12.667 6L14.667 8L12.667 10" stroke="#3585F5" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round" />\n                            <path d="M1.33301 8H14.6663" stroke="#3585F5" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round" />\n                            <path d="M8 1.33301V14.6663" stroke="#3585F5" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round" />\n                        </g>\n                        <defs>\n                            <clipPath id="clip0_388_3868">\n                                <rect width="16" height="16" fill="white" />\n                            </clipPath>\n                        </defs>\n                    </svg>\n                </button>\n                <button type="button" class="btn-delete" data-delete-id="${e.id}">\n                    <svg width="16" height="16" viewBox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg">\n                        <path d="M4.30007 12.4999C4.09537 12.4999 3.89057 12.4218 3.73437 12.2656C3.42188 11.9531 3.42188 11.4467 3.73437 11.1342L11.1343 3.7343C11.4468 3.4219 11.9532 3.4219 12.2657 3.7343C12.5781 4.0467 12.5781 4.55319 12.2657 4.86559L4.86576 12.2655C4.70956 12.4218 4.50477 12.4999 4.30007 12.4999Z" fill="#3585F5" />\n                        <path d="M11.7 12.4998C11.4952 12.4998 11.2905 12.4217 11.1343 12.2655L3.73437 4.86559C3.42188 4.55319 3.42188 4.0467 3.73437 3.7343C4.04677 3.4219 4.55327 3.4219 4.86566 3.7343L12.2656 11.1342C12.578 11.4467 12.578 11.9531 12.2656 12.2656C12.1095 12.4217 11.9048 12.4998 11.7 12.4998Z" fill="#3585F5" />\n                    </svg>\n                </button>\n                <button type="button" class="btn-edit" data-edit-id="${e.id}">\n                    <svg width="16" height="16" viewBox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg">\n                        <path d="M11.3333 2.00004C11.5084 1.82493 11.7163 1.68602 11.9451 1.59131C12.1739 1.49659 12.4191 1.44794 12.6667 1.44794C12.9142 1.44794 13.1594 1.49659 13.3882 1.59131C13.617 1.68602 13.8249 1.82493 14 2.00004C14.1751 2.17515 14.314 2.38306 14.4087 2.61185C14.5034 2.84064 14.5521 3.08582 14.5521 3.33337C14.5521 3.58092 14.5034 3.8261 14.4087 4.05489C14.314 4.28368 14.1751 4.49159 14 4.66671L4.66667 14L1.33333 14.6667L2 11.3334L11.3333 2.00004Z" stroke="#3585F5" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"/>\n                    </svg>\n                </button>\n            </div>\n        `;const i=t.querySelector(".image-container");i.appendChild(o);const n=new Image;return n.src=e.objectUrl,n.alt=e.name,n.dataset.bsToggle="tooltip",n.dataset.bsPlacement="top",n.dataset.bsTitle=e.isCheked?"Не показывать в объявлении":"Показывать в объявлении",n.onload=()=>{if(o.style.display="none",i.appendChild(n),"undefined"!=typeof bootstrap&&bootstrap.Tooltip){const e=new bootstrap.Tooltip(n,{trigger:"hover",placement:"top"});this.tooltips.set(n,e)}},n.onerror=()=>{o.style.display="none";const e=document.createElement("div");e.className="text-danger",e.textContent="Ошибка загрузки изображения",i.appendChild(e)},t}initEventHandlers(){this.renderContainer&&(this.renderContainer.addEventListener("change",e=>{if(e.target.matches('input[type="checkbox"][data-cheked-photo-id]')){const t=e.target.dataset.chekedPhotoId;this.togglePhotoSelection(t)}}),this.renderContainer.addEventListener("click",e=>{if(e.target.closest(".btn-delete")){const t=e.target.closest(".btn-delete").dataset.deleteId;this.deletePhoto(t),e.preventDefault()}if(e.target.closest(".btn-move")){const t=e.target.closest(".btn-move").dataset.moveId;this.movePhoto(t),e.preventDefault()}if(e.target.closest(".btn-edit")){const t=e.target.closest(".btn-edit").dataset.editId;this.editPhoto(t),e.preventDefault()}}))}editPhoto(e){const t=this.photoArray.find(t=>t.id===e);if(!t)return;const o=new Image;o.onload=()=>{const e=document.createElement("canvas");e.width=o.width,e.height=o.height;e.getContext("2d").drawImage(o,0,0),this.initImageEditor(e.toDataURL("image/jpeg"),t)},o.src=t.objectUrl}initImageEditor(e,t){const o=("ontouchstart"in window||navigator.maxTouchPoints>0)&&window.innerWidth<1024;document.body.classList.contains("lock")||document.body.classList.add("lock");const i=document.createElement("div");i.id="tui-image-editor-container",i.style.position="fixed",i.style.top="0",i.style.left="0",i.style.width="100%",i.style.height="100%",i.style.zIndex="9999",i.style.backgroundColor="#fff";const n=document.createElement("div");n.style.position="absolute",n.style.top="50%",n.style.left="50%",n.style.transform="translate(-50%, -50%)",n.textContent="Загрузка редактора...",i.appendChild(n),document.body.appendChild(i);const s=new Image;s.src=e,s.onload=()=>{try{const r=s.naturalWidth,a=s.naturalHeight,l=2e3,d=Math.max(r,a),c=20,h=30,p=Math.min(2,Math.max(.5,d/l)),m={min:25,max:150},u={min:55,max:150};let g;g=o?Math.min(u.max,Math.max(u.min,h*p)):Math.min(m.max,Math.max(m.min,c*p));const y=3*g,b={includeUI:{loadImage:{path:e,name:t.name},theme:{"common.bi.image":"","common.bisize.width":"0px","common.bisize.height":"0px","common.backgroundImage":"none","common.backgroundColor":"#fff","common.border":"1px solid #ddd"},menu:o?["crop","resize","rotate"]:["crop","resize","rotate","filter"],initMenu:"crop",uiSize:{width:"100%",height:"100%"},menuBarPosition:"bottom"},cssMaxWidth:window.innerWidth,cssMaxHeight:window.innerHeight,selectionStyle:{cornerSize:g,rotatingPointOffset:70,cornerStyle:"circle",borderColor:"#3585F5",borderWidth:5,cornerColor:"#3585F5",transparentCorners:!1}};this.imageEditor=new tui.ImageEditor(i,b),this.addEditorButtons(i,t),this.imageEditor.on("load",()=>{i.removeChild(n);const e=this.imageEditor._graphics.getCanvas();e.on("object:scaling",e=>{const t=e.target;t&&(t.set({cornerSize:g,borderScaleFactor:1}),t.setCoords())}),e.on("selection:created",t=>{t.selected&&t.selected.length>0&&(t.selected.forEach(e=>{e.set({cornerSize:g,borderScaleFactor:1})}),e.renderAll())}),setTimeout(()=>{this.imageEditor.startDrawingMode("CROPPER");const t=.8*e.width,o=.8*e.height,i=(e.width-t)/2,n=(e.height-o)/2;this.imageEditor.setCropzoneRect({left:i,top:n,width:t,height:o});const s=this.imageEditor._graphics._cropper;s&&s.set({borderColor:"#3585F5",cornerColor:"#3585F5",cornerSize:y,transparentCorners:!1,borderWidth:5})},300),o&&setTimeout(()=>{document.querySelectorAll(".tui-image-editor-header-logo, .tui-image-editor-range").forEach(e=>{e.style.display="none"})},300)}),setTimeout(()=>{const e=$(".tie-lock-aspect-ratio");e.length&&e.trigger("click")},300),o&&setTimeout(()=>{const e=$(".tie-lock-aspect-ratio");e.length&&(e.trigger("change"),$(".tie-height-range.tui-image-editor-range, .tie-width-range.tui-image-editor-range, .tie-rotate-range.tui-image-editor-range").hide())},300)}catch(e){console.error("Помилка ініціалізації редактора:",e),i.innerHTML='<div style="color:red;padding:20px;">Помилка завантаження редактора. Спробуйте ще раз.</div>'}},s.onerror=()=>{i.innerHTML='<div style="color:red;padding:20px;">Помилка завантаження зображення.</div>'}}addEditorButtons(e,t){const o=document.createElement("div");o.className="btn-tui-wrapper";const i=document.createElement("button");i.textContent="Сохранить",i.className="btn btn-primary  btn-tui-save",i.onclick=()=>this.saveEditedImage(t);const n=document.createElement("button");n.textContent="Отменить",n.className="btn btn-danger btn-tui-reset",n.onclick=()=>this.closeImageEditor(),o.appendChild(i),o.appendChild(n),e.appendChild(o)}saveEditedImage(e){if(!this.imageEditor)return;const t=this.imageEditor.toDataURL();fetch(t).then(e=>e.blob()).then(t=>{const o=new File([t],e.name,{type:"image/jpeg",lastModified:Date.now()});e.file=o,e.objectUrl=URL.createObjectURL(o),this.render(),this.closeImageEditor()}),document.body.classList.contains("lock")&&document.body.classList.remove("lock")}closeImageEditor(){this.imageEditor&&(this.imageEditor.destroy(),this.imageEditor=null);const e=document.getElementById("tui-image-editor-container");e&&e.remove();const t=document.querySelector('div[style*="z-index: 10000"]');t&&t.remove(),document.body.classList.contains("lock")&&document.body.classList.remove("lock")}togglePhotoSelection(e){const t=this.photoArray.find(t=>t.id===e);if(!t)return;t.isCheked=!t.isCheked;const o=this.renderContainer.querySelector(`[data-photo-id="${e}"] img`);if(o){o.setAttribute("data-bs-title",t.isCheked?"Не показывать в объявлении":"Показывать в объявлении");const e=bootstrap.Tooltip.getInstance(o);e&&(e.dispose(),this.tooltips.delete(o));const i=new bootstrap.Tooltip(o,{trigger:"hover",title:o.getAttribute("data-bs-title")});this.tooltips.set(o,i)}}deletePhoto(e){const t=this.renderContainer.querySelector(`[data-photo-id="${e}"]`);if(!t)return;const o=this.photoArray.findIndex(t=>t.id===e);if(-1===o)return;const i=t.querySelector("img");if(i){const e=bootstrap.Tooltip.getInstance(i);e&&(e.dispose(),this.tooltips.delete(i))}const n=this.photoArray[o];if(n.objectUrl)try{URL.revokeObjectURL(n.objectUrl)}catch(e){console.warn("Ошибка при освобождении URL:",e)}this.photoArray.splice(o,1),this.validPhotos=this.validPhotos.filter(t=>t.id!==e),t.remove()}movePhoto(e){console.log("Переместить фото с идентификатором: "+e)}initFancybox(){"undefined"!=typeof Fancybox&&(Fancybox.getInstance()&&Fancybox.getInstance().destroy(),Fancybox.bind("[data-fancybox]",{Thumbs:!1,Toolbar:{display:{left:["infobar"],middle:[],right:["close"]}},Images:{zoom:!0},on:{close:()=>{const e=Fancybox.getInstance();if(e){const t=e.getSlides();t&&t.forEach(e=>{e.content.src.startsWith("blob:")&&URL.revokeObjectURL(e.content.src)})}}}}))}initTooltips(){if("undefined"==typeof bootstrap||!bootstrap.Tooltip)return;(this.renderContainer&&this.renderContainer.querySelectorAll('[data-bs-toggle="tooltip"]')||[]).forEach(e=>{try{if(!this.tooltips.has(e)){const t=new bootstrap.Tooltip(e,{trigger:"hover",placement:"top"});this.tooltips.set(e,t)}}catch(e){console.warn("Ошибка при инициализации тултипа:",e)}})}destroyAllTooltips(){this.tooltips.forEach((e,t)=>{try{e&&"function"==typeof e.dispose&&e.dispose()}catch(e){console.warn("Ошибка при уничтожении тултипа:",e)}}),this.tooltips.clear()}getSelectedPhotos(){return this.photoArray.filter(e=>e.isCheked)}destroy(){this.clearOldObjectUrls(),this.destroyAllTooltips(),this.closeImageEditor(),this.globalLoader&&(this.globalLoader.remove(),this.globalLoader=null),"undefined"!=typeof Fancybox&&Fancybox.getInstance()&&Fancybox.getInstance().destroy(),this.input&&this.input.removeEventListener("change",this.handleFileUpload),this.renderContainer&&(this.renderContainer.removeEventListener("change",this.togglePhotoSelection),this.renderContainer.removeEventListener("click",this.handleContainerClick))}resizeImageToMinimum(e,t){return new Promise((o,i)=>{const n=new Image,s=URL.createObjectURL(e);n.onload=()=>{URL.revokeObjectURL(s);try{const s=n.naturalWidth,r=n.naturalHeight;let a,l;if(s<r){const e=this.minWidth/s;a=this.minWidth,l=Math.round(r*e)}else{const e=this.minHeight/r;l=this.minHeight,a=Math.round(s*e)}const d=document.createElement("canvas");d.width=a,d.height=l;const c=d.getContext("2d");c.imageSmoothingQuality="high",c.drawImage(n,0,0,a,l),d.toBlob(n=>{if(!n)return void i(new Error("Ошибка при создании blob из canvas"));const s=new File([n],e.name,{type:"image/jpeg",lastModified:Date.now()}),r={...t,file:s,width:a,height:l,size:n.size,wasResized:!0};o(r)},"image/jpeg",.92)}catch(e){i(e)}},n.onerror=()=>{URL.revokeObjectURL(s),i(new Error("Ошибка загрузки изображения для изменения размера"))},n.src=s})}}class PhotoLoaderMini{constructor(e){if(!e.inputId)throw new Error("Необходимо указать inputId");this.inputId=e.inputId,this.wrapperClass=e.wrapperClass||"photo-info-list",this.checkImageSize=!1!==e.checkImageSize,this.minWidth=e.minWidth||800,this.minHeight=e.minHeight||800,this.maxPhotos=1,this.input=document.querySelector("#"+this.inputId),this.wrapper=document.querySelector("."+this.wrapperClass),this.errorContainer=document.querySelector(".photo-info-list-wrapper > .error-container"),this.renderContainer=document.querySelector(".photo-info-list"),this.validPhotos=[],this.invalidPhotos=[],this.photoArray=[],this.tooltips=new Map,this.isProcessing=!1,this.globalLoader=null,this.uploadButton=null,this.input&&this.wrapper?(this.createGlobalLoader(),this.init(),this.uploadButton=document.querySelector(".photo-info-list .photo-info-btn-wrapper")):console.error("Не удалось найти необходимые DOM-элементы")}createGlobalLoader(){this.globalLoader=document.createElement("div"),this.globalLoader.className="photo-loader-global",this.globalLoader.innerHTML='\n      <div class="photo-loader-content">\n        <div class="photo-loader-spinner"></div>\n        <div class="photo-loader-text">Загрузка фото...</div>\n        <div class="photo-loader-progress">0%</div>\n      </div>\n    ',document.body.appendChild(this.globalLoader),this.globalLoader.style.display="none"}showLoader(){this.globalLoader&&(this.globalLoader.style.display="flex")}hideLoader(){this.globalLoader&&(this.globalLoader.style.display="none")}updateProgress(e,t){if(!this.globalLoader)return;const o=Math.round(e/t*100),i=this.globalLoader.querySelector(".photo-loader-progress");i&&(i.textContent=o+"%")}init(){this.input.addEventListener("change",async e=>{if(!this.isProcessing){this.isProcessing=!0,this.wrapper.classList.add("loading"),this.showLoader();try{this.clearOldObjectUrls(),this.photoArray=[],this.validPhotos=[],this.invalidPhotos=[],this.renderContainer.innerHTML="";let t=0;const o=e.target.files.length,i=()=>{t++,this.updateProgress(t,o)};await this.handleFileUpload(e,i)}catch(e){console.error("Ошибка загрузки файлов:",e)}finally{this.isProcessing=!1,this.wrapper.classList.remove("loading"),this.hideLoader(),this.updateProgress(0,1)}}})}async handleFileUpload(e,t){const o=Array.from(e.target.files);if(this.photoArray.length+o.length>this.maxPhotos)return this.invalidPhotos.push({text:"Можно загрузить только 1 фото. Лишние файлы будут проигнорированы."}),void this.displayErrors();const i=o.map(e=>new Promise(o=>{e.type.match("image.*")||e.name.toLowerCase().endsWith(".heic")||e.name.toLowerCase().endsWith(".heif")?this.handleImage(e).then(()=>{t(),o()}).catch(e=>{console.error("Ошибка обработки изображения:",e),t(),o()}):(this.handleInvalidFile(e),t(),o())}));await Promise.all(i),this.displayResults()}handleImage(e){return new Promise((t,o)=>{("image/heic"===e.type||"image/heif"===e.type||e.name.toLowerCase().endsWith(".heic")||e.name.toLowerCase().endsWith(".heif"))&&"undefined"!=typeof heic2any?this.convertHeicToJpg(e).then(e=>this.processImageFile(e,t,o)).catch(o):this.processImageFile(e,t,o)})}convertHeicToJpg(e){return new Promise((t,o)=>{heic2any({blob:e,toType:"image/jpeg",quality:.8}).then(o=>{const i=new File([o],e.name.replace(/\.(heic|heif)$/i,".jpg"),{type:"image/jpeg",lastModified:Date.now()});t(i)}).catch(o)})}processImageFile(e,t,o){const i=new Image,n=URL.createObjectURL(e);i.onerror=()=>{URL.revokeObjectURL(n),this.invalidPhotos.push({text:"Ошибка загрузки изображения: "+e.name,file:e}),o(new Error("Ошибка загрузки изображения: "+e.name))},i.onload=()=>{URL.revokeObjectURL(n);try{const n=i.naturalWidth,s=i.naturalHeight;this.resizeImageToMinimum(e,{width:n,height:s}).then(e=>{this.validPhotos.push(e),this.photoArray.push(e),t()}).catch(t=>{console.error("Ошибка при изменении размера изображения:",t),this.invalidPhotos.push({text:"Ошибка обработки изображения: "+e.name,file:e}),o(t)})}catch(t){console.error("Ошибка обработки изображения:",t),this.invalidPhotos.push({text:"Ошибка обработки изображения: "+e.name,file:e}),o(t)}},i.src=n}resizeImageToMinimum(e,t){return new Promise((o,i)=>{const n=new Image,s=URL.createObjectURL(e);n.onload=()=>{URL.revokeObjectURL(s);try{let s=t.width,r=t.height;const a=Math.min(s,r),l=this.minWidth/a,d=Math.round(s*l),c=Math.round(r*l),h=document.createElement("canvas");h.width=d,h.height=c;const p=h.getContext("2d");p.imageSmoothingQuality="high",p.drawImage(n,0,0,d,c),h.toBlob(t=>{if(!t)return void i(new Error("Ошибка при создании blob из canvas"));const n=new File([t],e.name,{type:"image/jpeg",lastModified:Date.now()}),s={id:this.generateUniqueId(),name:e.name,size:t.size,width:d,height:c,file:n,isCheked:!0,objectUrl:null,originalFileType:e.type};o(s)},"image/jpeg",.9)}catch(e){i(e)}},n.onerror=()=>{URL.revokeObjectURL(s),i(new Error("Ошибка загрузки изображения для изменения размера"))},n.src=s})}generateUniqueId(){return Date.now().toString(36)+Math.random().toString(36).substr(2)}handleInvalidFile(e){this.invalidPhotos.push({text:`Файл "${e.name}" не является изображением. Допустимы только изображения (JPG/PNG/HEIC/HEIF).`,file:e})}displayResults(){this.displayErrors(),this.render()}clearOldObjectUrls(){this.photoArray.forEach(e=>{e.objectUrl&&(URL.revokeObjectURL(e.objectUrl),e.objectUrl=null)})}clearErrors(){if(!this.wrapper||!this.errorContainer)return;this.wrapper.classList.remove("error");this.errorContainer.querySelectorAll(".error").forEach(e=>e.remove())}displayErrors(){this.wrapper&&this.errorContainer&&(this.clearErrors(),this.invalidPhotos.length>0&&(this.wrapper.classList.add("error"),this.invalidPhotos.forEach(e=>{const t=document.createElement("div");t.textContent=e.text,t.classList.add("error"),this.errorContainer.appendChild(t)})))}render(){if(!this.renderContainer)return;this.destroyAllTooltips();this.renderContainer.querySelectorAll(".photo-info-item").forEach(e=>e.remove()),this.photoArray.forEach(e=>{e.objectUrl||(e.objectUrl=URL.createObjectURL(e.file));const t=this.createPhotoElement(e);this.uploadButton&&this.uploadButton.parentNode===this.renderContainer?this.renderContainer.insertBefore(t,this.uploadButton):this.renderContainer.appendChild(t)}),this.uploadButton&&this.uploadButton.parentNode!==this.renderContainer&&this.renderContainer.appendChild(this.uploadButton),this.toggleUploadButtonVisibility(),this.initTooltips(),this.initFancybox(),this.initEventHandlers()}toggleUploadButtonVisibility(){this.uploadButton&&(this.uploadButton.style.display=0===this.photoArray.length?"block":"none")}createSpinnerElement(){const e=document.createElement("div");e.className="spinner-border text-primary",e.style.width="50px",e.style.height="50px",e.setAttribute("role","status");const t=document.createElement("span");return t.className="visually-hidden",t.textContent="Загрузка...",e.appendChild(t),e}createPhotoElement(e){const t=document.createElement("li");t.classList.add("photo-info-item"),t.setAttribute("data-photo-id",e.id);const o=this.createSpinnerElement();t.innerHTML=`\n      <label>\n        <input type="checkbox" ${e.isCheked?"checked":""}\n               data-cheked-photo-id="${e.id}">\n        <div class="image-container">\n        </div>\n      </label>\n      <div class="photo-info-item-actions">\n        <button type="button" class="btn-see" aria-label="eye"\n                data-fancybox data-src="${e.objectUrl}">\n          <svg width="16" height="16" viewBox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg">\n            <path d="M14.5 8C14.5 8 11.6 12 8 12C4.4 12 1.5 8 1.5 8C1.5 8 4.4 4 8 4C11.6 4 14.5 8 14.5 8Z" stroke="#3585F5" stroke-width="1.5" stroke-miterlimit="10" stroke-linejoin="round" />\n            <path d="M8 10C9.10457 10 10 9.10457 10 8C10 6.89543 9.10457 6 8 6C6.89543 6 6 6.89543 6 8C6 9.10457 6.89543 10 8 10Z" stroke="#3585F5" stroke-width="1.5" stroke-miterlimit="10" stroke-linejoin="round" />\n          </svg>\n        </button>\n        <button type="button" class="btn-delete" data-delete-id="${e.id}">\n          <svg width="16" height="16" viewBox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg">\n            <path d="M4.30007 12.4999C4.09537 12.4999 3.89057 12.4218 3.73437 12.2656C3.42188 11.9531 3.42188 11.4467 3.73437 11.1342L11.1343 3.7343C11.4468 3.4219 11.9532 3.4219 12.2657 3.7343C12.5781 4.0467 12.5781 4.55319 12.2657 4.86559L4.86576 12.2655C4.70956 12.4218 4.50477 12.4999 4.30007 12.4999Z" fill="#3585F5" />\n            <path d="M11.7 12.4998C11.4952 12.4998 11.2905 12.4217 11.1343 12.2655L3.73437 4.86559C3.42188 4.55319 3.42188 4.0467 3.73437 3.7343C4.04677 3.4219 4.55327 3.4219 4.86566 3.7343L12.2656 11.1342C12.578 11.4467 12.578 11.9531 12.2656 12.2656C12.1095 12.4217 11.9048 12.4998 11.7 12.4998Z" fill="#3585F5" />\n          </svg>\n        </button>\n      </div>\n    `;const i=t.querySelector(".image-container");i.appendChild(o);const n=new Image;return n.src=e.objectUrl,n.alt=e.name,n.dataset.bsToggle="tooltip",n.dataset.bsPlacement="top",n.dataset.bsTitle=e.isCheked?"Не отображать фото":"Отображать фото",n.onload=()=>{if(o.style.display="none",i.appendChild(n),"undefined"!=typeof bootstrap&&bootstrap.Tooltip){const e=new bootstrap.Tooltip(n,{trigger:"hover",placement:"top"});this.tooltips.set(n,e)}},n.onerror=()=>{o.style.display="none";const e=document.createElement("div");e.className="text-danger",e.textContent="Ошибка загрузки изображения",i.appendChild(e)},t}initEventHandlers(){this.renderContainer&&(this.renderContainer.addEventListener("change",e=>{if(e.target.matches('input[type="checkbox"][data-cheked-photo-id]')){const t=e.target.dataset.chekedPhotoId;this.togglePhotoSelection(t)}}),this.renderContainer.addEventListener("click",e=>{if(e.target.closest(".btn-delete")){const t=e.target.closest(".btn-delete").dataset.deleteId;this.deletePhoto(t),e.preventDefault()}}))}togglePhotoSelection(e){const t=this.photoArray.find(t=>t.id===e);if(!t)return;t.isCheked=!t.isCheked;const o=this.renderContainer.querySelector(`[data-photo-id="${e}"] img`);if(o){o.setAttribute("data-bs-title",t.isCheked?"Не показывать в объявлении":"Показывать в объявлении");const e=bootstrap.Tooltip.getInstance(o);e&&(e.dispose(),this.tooltips.delete(o));const i=new bootstrap.Tooltip(o,{trigger:"hover",title:o.getAttribute("data-bs-title")});this.tooltips.set(o,i)}}deletePhoto(e){const t=this.renderContainer.querySelector(`[data-photo-id="${e}"]`);if(!t)return;const o=this.photoArray.findIndex(t=>t.id===e);if(-1===o)return;const i=this.photoArray[o];i.objectUrl&&URL.revokeObjectURL(i.objectUrl),this.photoArray.splice(o,1),this.validPhotos=this.validPhotos.filter(t=>t.id!==e),t.remove(),this.input.value="",this.toggleUploadButtonVisibility()}initFancybox(){"undefined"!=typeof Fancybox&&(Fancybox.getInstance()&&Fancybox.getInstance().destroy(),Fancybox.bind("[data-fancybox]",{Thumbs:!1,Toolbar:{display:{left:["infobar"],middle:[],right:["close"]}},Images:{zoom:!0},on:{close:()=>{const e=Fancybox.getInstance();if(e){const t=e.getSlides();t&&t.forEach(e=>{e.content.src.startsWith("blob:")&&URL.revokeObjectURL(e.content.src)})}}}}))}initTooltips(){if("undefined"==typeof bootstrap||!bootstrap.Tooltip)return;(this.renderContainer&&this.renderContainer.querySelectorAll('[data-bs-toggle="tooltip"]')||[]).forEach(e=>{try{if(!this.tooltips.has(e)){const t=new bootstrap.Tooltip(e,{trigger:"hover",placement:"top"});this.tooltips.set(e,t)}}catch(e){console.warn("Ошибка при инициализации тултипа:",e)}})}destroyAllTooltips(){this.tooltips.forEach((e,t)=>{try{e&&"function"==typeof e.dispose&&e.dispose()}catch(e){console.warn("Ошибка при уничтожении тултипа:",e)}}),this.tooltips.clear()}getSelectedPhotos(){return this.photoArray.filter(e=>e.isCheked)}destroy(){this.clearOldObjectUrls(),this.destroyAllTooltips(),this.globalLoader&&(this.globalLoader.remove(),this.globalLoader=null),"undefined"!=typeof Fancybox&&Fancybox.getInstance()&&Fancybox.getInstance().destroy(),this.input&&this.input.removeEventListener("change",this.handleFileUpload),this.renderContainer&&(this.renderContainer.removeEventListener("change",this.togglePhotoSelection),this.renderContainer.removeEventListener("click",this.handleContainerClick))}}class PhoneInputManager{constructor(e){this.options={...e},this.phoneCounter=1,this.btnAddTel=document.querySelector(this.options.btnSelector),this.wrapper=document.querySelector(this.options.wrapperSelector),document.addEventListener("DOMContentLoaded",()=>{this.init()})}init(){if(!this.btnAddTel||!this.wrapper)return;this.phoneCounter=this.wrapper.querySelectorAll("[data-phone-item]").length,this.btnAddTel.addEventListener("click",e=>this.addPhoneField(e)),this.wrapper.querySelectorAll("[data-phone-item]").forEach((e,t)=>{const o=e.querySelector("."+this.options.inputClass);o&&(this.initTelInput(o),t>0&&this.addDeleteButton(e))});this.wrapper.querySelectorAll("[data-phone-item]").length>=this.options.maxPhones&&(this.btnAddTel.style.display="none")}addPhoneField(e){const t=this.wrapper.querySelectorAll("[data-phone-item]").length;if(t>=this.options.maxPhones)return void alert("Максимальна кількість телефонів - "+this.options.maxPhones);this.phoneCounter++;const o=this.createPhoneField();this.wrapper.querySelector("[data-phone-item]").appendChild(o),this.initTelInput(o.querySelector("."+this.options.inputClass)),this.addDeleteButton(o),t+1>=this.options.maxPhones&&(this.btnAddTel.style.display="none")}createPhoneField(){const e=document.createElement("div");return e.className="item",e.setAttribute("data-phone-item",""),e.innerHTML=`\n            <div class="add_new-tel">\n                <button type="button" class="btn btn-new-tel">\n                    <svg width="11" height="11" viewBox="0 0 11 11" fill="none" xmlns="http://www.w3.org/2000/svg">\n                        <path d="M0.471859 5.47374C0.358138 5.36002 0.28775 5.20285 0.287749 5.0293C0.28775 4.68208 0.569081 4.40075 0.916301 4.40075L9.13847 4.40075C9.48563 4.4008 9.76697 4.68213 9.76702 5.0293C9.76702 5.3764 9.48563 5.65779 9.13853 5.65779H0.916357C0.742747 5.65785 0.585581 5.58746 0.471859 5.47374Z" fill="#3585F5" />\n                        <path d="M4.583 9.58476C4.46922 9.47098 4.39889 9.31387 4.39889 9.14032L4.39889 0.918164C4.39883 0.571001 4.68022 0.289614 5.02739 0.28967C5.37449 0.28967 5.65588 0.571056 5.65588 0.918164L5.65588 9.14032C5.65583 9.48748 5.37449 9.76881 5.02733 9.76887C4.85389 9.76887 4.69678 9.69853 4.583 9.58476Z" fill="#3585F5" />\n                    </svg>\n                </button>\n            </div>\n            <label for="tel-contact${this.phoneCounter}">Телефон</label>\n            <div class="item-inputText-wrapper">\n                <input class="item-inputText ${this.options.inputClass}" id="tel-contact${this.phoneCounter}" type="tel" autocomplete="off">\n            </div>\n        `,e}addDeleteButton(e){const t=e.querySelector(".add_new-tel").querySelector(".btn-new-tel");t.innerHTML='\n            <svg width="10" height="10" viewBox="0 0 10 10" fill="none" xmlns="http://www.w3.org/2000/svg">\n                <path d="M0.932895 9.93359C0.708205 9.93359 0.483405 9.84787 0.311951 9.67641C-0.0310669 9.3334 -0.0310669 8.77754 0.311951 8.43452L8.43461 0.311868C8.77763 -0.0310395 9.33348 -0.0310395 9.67649 0.311868C10.0194 0.654776 10.0194 1.21074 9.67649 1.55365L1.55384 9.6763C1.38239 9.84787 1.15759 9.93359 0.932895 9.93359Z" fill="#f00" />\n                <path d="M9.05555 9.93348C8.83075 9.93348 8.60606 9.84776 8.43461 9.6763L0.311951 1.55365C-0.0310669 1.21074 -0.0310669 0.654776 0.311951 0.311868C0.654859 -0.0310395 1.21082 -0.0310395 1.55373 0.311868L9.67638 8.43452C10.0193 8.77754 10.0193 9.3334 9.67638 9.67641C9.50504 9.84776 9.28035 9.93348 9.05555 9.93348Z" fill="#f00" />\n            </svg>\n        ',t.addEventListener("click",t=>{t.preventDefault(),this.removePhoneField(e)})}removePhoneField(e){e.remove();const t=this.wrapper.querySelectorAll("[data-phones] .item").length;t<this.options.maxPhones&&(this.btnAddTel.style.display="block"),this.phoneCounter=t}initTelInput(e){const t=$(e);if(e._iti)return;const o=window.intlTelInput(e,{initialCountry:this.options.initialCountry,utilsScript:this.options.utilsScript,separateDialCode:!0,nationalMode:!0,autoPlaceholder:"aggressive",customPlaceholder:(e,t)=>e.replace(/[0-9]/g,"_")}),i=e=>{const o=this.options.countryMasks[e]||this.options.countryMasks.default;t.unmask().mask(o,{clearIfNotMatch:!0}),t.val()&&t.trigger("input")};t.on("countrychange",()=>{i(o.getSelectedCountryData().iso2)}),t.on("keypress",e=>{/[0-9]/.test(String.fromCharCode(e.which))||e.preventDefault()}),t.on("blur",()=>{if(t.val()){const e=o.getNumber();e&&t.val(e.replace(/[^\d]/g,""))}}),i(o.getSelectedCountryData().iso2),setTimeout(()=>{t.trigger("countrychange")},100)}}class RealEstateDescriptionGenerator{constructor(e,t){this.apiKey=e,this.options={...t},this.btnElement=document.querySelector(this.options.btnSelector),this.init()}init(){this.btnElement?this.btnElement.addEventListener("click",e=>this.generateDescription(e)):console.error("Не знайдено кнопку генерації")}async generateDescription(e){if(e.preventDefault(),this.apiKey)try{const e=this.buildPrompt(),t=await this.fetchGPTResponse(e);t&&this.updateTextareas(t)}catch(e){console.error("Помилка генерації опису:",e)}else console.error("API ключ не вказано")}buildPrompt(){const e={location:"Локація: Парус",city:"місто: Дніпро",district:"район: Індустріальний",street:"вулиця: набережна Перемоги",residentialComplex:"назва комплексу: Sun City",typeRealEstate:"тип нерухомості: квартира",numberRooms:"кількість кімнат: 3",condition:"стан нерухомості: без ремонту",tags:"перелік додаткових тегів: парковка, дитячий майданчик, поруч магазини, панорамний вид з вікна"},t=t=>e[t]?e[t].split(":").slice(1).join(":").trim():null,o=Object.entries({"Локація":t("location"),"Місто":t("city"),"Район":t("district"),"Вулиця":t("street"),"Житловий комплекс":t("residentialComplex"),"Тип нерухомості":t("typeRealEstate"),"Кількість кімнат":t("numberRooms"),"Стан":t("condition"),"Додаткові переваги":t("tags")}).filter(([e,t])=>null!==t);return`Згенеруй привабливий опис для оголошення нерухомості мінімум на ${this.options.minWords} слів\n      українською мовою, російською, англійською. Розділи ці 3 переклади через коди мов ua,ru,en. Ось дані об'єкта:\n      ${o.map(([e,t])=>`- ${e}: ${t}`).join("\n")}`}async fetchGPTResponse(e){const t=await fetch("https://api.openai.com/v1/chat/completions",{method:"POST",headers:{"Content-Type":"application/json",Authorization:"Bearer "+this.apiKey},body:JSON.stringify({model:this.options.model,messages:[{role:"user",content:e}],temperature:this.options.temperature})});if(!t.ok)throw new Error("HTTP помилка! Статус: "+t.status);const o=await t.json();return o&&o.choices&&o.choices[0]&&o.choices[0].message&&o.choices[0].message.content}updateTextareas(e){const t=this.parseTranslations(e);document.querySelectorAll(this.options.textareaSelector).forEach(e=>{const o=e.dataset.textareaLang;t[o]&&(e.value=t[o])})}parseTranslations(e){const t=e.trim().split("\n\n"),o={};return t.forEach(e=>{const[t,...i]=e.split(":"),n=t.trim(),s=i.join(":").trim();this.options.languages.includes(n)&&(o[n]=s)}),o}}class GoogleMapsManager{constructor(){this.map=null,this.marker=null,this.geocoder=null,this.autocomplete=null,this.googleMapsAPILoaded=!1,this.scriptLoaded=!1}loadAPI(){return new Promise((e,t)=>{if(this.googleMapsAPILoaded)return void e();if("undefined"!=typeof google&&google.maps)return this.googleMapsAPILoaded=!0,void e();if(this.scriptLoaded){const t=setInterval(()=>{this.googleMapsAPILoaded&&(clearInterval(t),e())},100);return}const o=document.createElement("script");o.src="https://maps.googleapis.com/maps/api/js?key=AIzaSyB-JxH1yXZg7DPInjpOmGFMvCNX5vFPzkg&loading=async&libraries=places,marker&callback=onGoogleMapsAPILoaded",o.async=!0,o.defer=!0,o.onerror=()=>{this.scriptLoaded=!1,t(new Error("Failed to load Google Maps API"))},document.head.appendChild(o),this.scriptLoaded=!0,window.onGoogleMapsAPILoaded=()=>{this.googleMapsAPILoaded=!0,e()}})}initializeMap(e){try{if(!(this.googleMapsAPILoaded&&google.maps&&google.maps.Map&&google.maps.marker))throw new Error("Google Maps API not loaded correctly");const{AdvancedMarkerElement:t}=google.maps.marker;this.map=new google.maps.Map(document.getElementById(e),{center:{lat:50.4501,lng:30.5234},zoom:12,mapId:"YOUR_MAP_ID",streetViewControl:!1,mapTypeControl:!1}),this.geocoder=new google.maps.Geocoder,this.marker=new t({map:this.map,position:this.map.getCenter(),gmpDraggable:!1}),this.map.addListener("center_changed",()=>{const e=this.map.getCenter();this.marker.position=e,this.updateAddressFromLocation(e)}),this.map.addListener("idle",()=>{const e=this.map.getCenter();this.updateFormFields(e)}),this.initAutocomplete()}catch(e){throw console.error("Map initialization error:",e),e}}initAutocomplete(){try{this.autocomplete=new google.maps.places.Autocomplete(document.getElementById("address"),{types:["geocode"],fields:["geometry","formatted_address"]}),this.autocomplete.addListener("place_changed",()=>{const e=this.autocomplete.getPlace();e.geometry?(this.map.setCenter(e.geometry.location),e.geometry.viewport?this.map.fitBounds(e.geometry.viewport):this.map.setZoom(17)):alert("Place not found: '"+e.name+"'")})}catch(e){throw console.error("Autocomplete initialization error:",e),e}}updateAddressFromLocation(e){this.geocoder.geocode({location:e},(e,t)=>{"OK"===t&&e[0]&&$("#address").val(e[0].formatted_address)})}updateFormFields(e){$("#latitude").val(e.lat().toFixed(6)),$("#longitude").val(e.lng().toFixed(6)),this.updateAddressFromLocation(e)}clearFields(){$("#address, #latitude, #longitude").val("")}}class RowManager{constructor(e){this.options={addBtnSelector:".btn-primary",rowSelector:".create-filter-row",rowContainerSelector:".create-filter-container",...e},this.rowCounter=1,this.init()}init(){const e=document.querySelectorAll(this.options.rowSelector);this.rowCounter=e.length;const t=document.querySelector(this.options.addBtnSelector);t&&t.addEventListener("click",()=>this.addNewRow()),e.forEach((e,t)=>{t>0&&this.addDeleteButton(e)})}addNewRow(){this.rowCounter++;const e=this.createNewRow(),t=document.querySelector(this.options.rowContainerSelector)||document.querySelector(this.options.rowSelector)&&document.querySelector(this.options.rowSelector).parentElement;t&&(t.appendChild(e),this.initSelect2(e))}createNewRow(){const e=document.createElement("div");return e.className="create-filter-row row2",e.innerHTML=`\n      <div class="item size-btn">\n        <button class="btn btn-danger btn-remove" type="button">\n         <svg width="18" height="18" viewBox="0 0 18 18" fill="none" xmlns="http://www.w3.org/2000/svg">\n\t\t   <path d="M2.62231 9.62222C2.4631 9.46301 2.36455 9.24298 2.36455 9C2.36455 8.51389 2.75842 8.12003 3.24453 8.12003L14.7556 8.12003C15.2416 8.12011 15.6355 8.51397 15.6356 9C15.6356 9.48595 15.2416 9.87989 14.7557 9.87989L3.24461 9.87989C3.00155 9.87997 2.78152 9.78143 2.62231 9.62222Z" fill="#fff" />\n\t\t </svg>\n        </button>\n      </div>\n      <div class="item size-1-2">\n        <span>\n          <label class="item-label" for="counter-section-${this.rowCounter}">Секция</label>\n        </span>\n        <input class="item-inputText" id="counter-section-${this.rowCounter}" type="text" autocomplete="off">\n      </div>\n      <div class="item selects">\n        <label class="item-label" for="counter-street-${this.rowCounter}">Улица</label>\n        <select id="counter-street-${this.rowCounter}" class="js-example-responsive3 my-select2" autocomplete="off">\n          <option value=""></option>\n          <option value="company">Тенистая</option>\n        </select>\n      </div>\n      <div class="item size0-5">\n        <span>\n          <label class="item-label" for="counter-number-house-${this.rowCounter}">№ Дом</label>\n        </span>\n        <input class="item-inputText" id="counter-number-house-${this.rowCounter}" type="text" autocomplete="off">\n      </div>\n      <div class="item size0-5">\n        <span>\n          <label class="item-label" for="counter-floor-${this.rowCounter}">Этажн.</label>\n        </span>\n        <input class="item-inputText" id="counter-floor-${this.rowCounter}" type="text" autocomplete="off">\n      </div>\n      <div class="item selects size0-5">\n        <label class="item-label" for="years-building-${this.rowCounter}">Год</label>\n        <select id="years-building-${this.rowCounter}" class="js-example-responsive3 my-select2" autocomplete="off">\n          <option value=""></option>\n          <option value="brick">2030</option>\n        </select>\n      </div>\n      <div class="item selects">\n        <label class="item-label" for="heating-${this.rowCounter}">Отопление</label>\n        <select id="heating-${this.rowCounter}" class="js-example-responsive3 my-select2" autocomplete="off">\n          <option value=""></option>\n          <option value="brick">Централизованное</option>\n        </select>\n      </div>\n      <div class="item selects">\n        <label class="item-label" for="wall-type-${this.rowCounter}">Тип стен</label>\n        <select id="wall-type-${this.rowCounter}" class="js-example-responsive3 my-select2" autocomplete="off">\n          <option value=""></option>\n          <option value="brick">Кирпич</option>\n        </select>\n      </div>\n    `,this.addDeleteButton(e),e}addDeleteButton(e){const t=e.querySelector(".btn-remove");t&&t.addEventListener("click",()=>{e.remove(),this.rowCounter--})}initSelect2(e){"undefined"!=typeof jQuery&&jQuery.fn.select2&&e.querySelectorAll(".my-select2").forEach(e=>{jQuery(e).data("select2")||jQuery(e).select2({width:"resolve"})})}}class RowManagerDevelopers{constructor(e){this.options={addBtnSelector:".btn-plus-row",rowSelector:".create-filter-row",rowContainerSelector:".create-filter-container",...e},this.rowCounter=1,this.init()}init(){const e=document.querySelectorAll(this.options.rowSelector);this.rowCounter=e.length;const t=document.querySelector(this.options.addBtnSelector);t&&t.addEventListener("click",()=>this.addNewRow()),e.forEach((e,t)=>{t>0&&this.addDeleteButton(e),this.initDropdownForRow(e)})}addNewRow(){this.rowCounter++;const e=this.createNewRow(),t=document.querySelector(this.options.rowContainerSelector)||document.querySelector(this.options.rowSelector)&&document.querySelector(this.options.rowSelector).parentElement;t&&(t.appendChild(e),this.initDropdownForRow(e))}createNewRow(){const e=document.createElement("div");return e.className="create-filter-row row2",e.innerHTML=`\n      <div class="item size-btn">\n        <button class="btn btn-danger btn-remove" type="button">\n          <svg width="18" height="18" viewBox="0 0 18 18" fill="none" xmlns="http://www.w3.org/2000/svg">\n            <path d="M2.62231 9.62222C2.4631 9.46301 2.36455 9.24298 2.36455 9C2.36455 8.51389 2.75842 8.12003 3.24453 8.12003L14.7556 8.12003C15.2416 8.12011 15.6355 8.51397 15.6356 9C15.6356 9.48595 15.2416 9.87989 14.7557 9.87989L3.24461 9.87989C3.00155 9.87997 2.78152 9.78143 2.62231 9.62222Z" fill="#fff"/>\n          </svg>\n        </button>\n      </div>\n      <div class="item size3">\n        <label>Локация</label>\n        <div class="my-dropdown" data-row="${this.rowCounter}">\n          <div class="my-dropdown-input-wrapper">\n            <button class="my-dropdown-geo-btn" data-bs-toggle="modal" data-bs-target="#geoModal">\n              <img src="./img/icon/geo.svg" alt="">\n            </button>\n            <label class="my-dropdown-label">\n              <input class="my-dropdown-input" type="text" autocomplete="off" placeholder="Введите название">\n            </label>\n            <button class="my-dropdown-btn arrow-down btn-open-menu" type="button">\n              <img src="./img/icon/arrow-right-white.svg" alt="">\n            </button>\n          </div>\n          <div class="my-dropdown-list-wrapper" style="display: none">\n            <div class="my-dropdown-list">\n              <div class="scroller">\n                <div class="my-dropdown-item">\n                  <label class="my-dropdown-item-label-radio">\n                    <input class="my-dropdown-item-radio" type="radio" name="country-${this.rowCounter}">\n                    <span class="my-dropdown-item-radio-text">Україна (<span>24</span>)</span>\n                  </label>\n                  <div class="my-dropdown-next-list" style="display: none">\n                    <div class="my-dropdown-item">\n                      <label class="my-dropdown-item-label-radio">\n                        <input class="my-dropdown-item-radio" type="radio" name="district-${this.rowCounter}">\n                        <span class="my-dropdown-item-radio-text">Дніпропетровська обл. (<span>24</span>)</span>\n                      </label>\n                    </div>\n                  </div>\n                </div>\n              </div>\n            </div>\n            <div class="my-dropdown-list second" style="display: none">\n              <div class="scroller">\n                <div class="my-dropdown-item">\n                  <label class="my-dropdown-item-label-checkbox">\n                    <input class="my-dropdown-item-checkbox" type="checkbox">\n                    <span class="my-dropdown-item-checkbox-text">Дніпро (<span>24</span>)</span>\n                  </label>\n                  <div class="my-dropdown-next-list" style="display: none">\n                    <div class="my-dropdown-item">\n                      <label class="my-dropdown-item-label-checkbox">\n                        <input class="my-dropdown-item-checkbox" type="checkbox">\n                        <span class="my-dropdown-item-checkbox-text">Індустріальний район (<span>24</span>)</span>\n                      </label>\n                      <div class="my-dropdown-next-next-list" style="display: none">\n                        <div class="my-dropdown-item">\n                          <label class="my-dropdown-item-label-checkbox">\n                            <input class="my-dropdown-item-checkbox" type="checkbox">\n                            <span class="my-dropdown-item-checkbox-text">Лівобережний 3 (<span>24</span>)</span>\n                          </label>\n                        </div>\n                      </div>\n                    </div>\n                  </div>\n                </div>\n              </div>\n            </div>\n          </div>\n          <div class="my-dropdown-search-wrapper" style="display: none">\n            <div class="my-dropdown-search-list">\n              <div class="scroller">\n                <div class="my-dropdown-search-item">\n                  <div class="eqweqw">Одесская обл (24)</div>\n                </div>\n              </div>\n            </div>\n          </div>\n        </div>\n      </div>\n      <div class="item size1">\n        <span>\n          <label class="item-label" for="year-${this.rowCounter}">Год</label>\n        </span>\n        <input class="item-inputText" id="year-${this.rowCounter}" type="text" autocomplete="off" placeholder="Имя Фамилия Отчество">\n      </div>\n      <div class="item size1">\n        <span>\n          <label class="item-label" for="google-disk-${this.rowCounter}">Google Диск (объекты девелопера)</label>\n        </span>\n        <input class="item-inputText" id="google-disk-${this.rowCounter}" type="url" autocomplete="off" placeholder="https://">\n      </div>\n    `,this.addDeleteButton(e),e}addDeleteButton(e){const t=e.querySelector(".btn-remove");t&&t.addEventListener("click",()=>{e.remove(),this.rowCounter--})}initDropdownForRow(e){const t=e.querySelector(".my-dropdown");if(!t)return;const o=t.getAttribute("data-row"),i=t.querySelector(".btn-open-menu"),n=t.querySelector(".my-dropdown-input"),s=t.querySelector(".my-dropdown-list-wrapper"),r=t.querySelector(".my-dropdown-search-wrapper");function a(e){e.querySelectorAll(".my-dropdown-list.second .my-dropdown-item-checkbox").forEach(e=>{e.checked=!1;const t=e.closest(".my-dropdown-item").querySelector(".my-dropdown-next-list");t&&(t.style.display="none")})}i.addEventListener("click",(function(){s.style.display="none"===s.style.display?"block":"none",this.classList.toggle("active"),r.style.display="none"})),n.addEventListener("input",(function(){this.value.trim().length>0?(r.style.display="block",s.style.display="none"):(r.style.display="none",s.style.display="block")})),t.querySelectorAll(`.my-dropdown-item-radio[name="country-${o}"]`).forEach(e=>{e.addEventListener("click",(function(){t.querySelectorAll(".my-dropdown-next-list").forEach(e=>{e.style.display="none"}),this.closest(".my-dropdown-item").querySelector(".my-dropdown-next-list").style.display="flex",t.querySelector(".my-dropdown-list.second").style.display="none",a(t),function(e,t){e.querySelectorAll(`.my-dropdown-next-list .my-dropdown-item-radio[name="district-${t}"]`).forEach(e=>{e.checked=!1})}(t,o)}))}),t.querySelectorAll(`.my-dropdown-item-radio[name="district-${o}"]`).forEach(e=>{e.addEventListener("click",(function(){this.checked&&(t.querySelector(".my-dropdown-list.second").style.display="flex")}))}),t.querySelectorAll(".my-dropdown-item-checkbox").forEach(e=>{e.addEventListener("change",(function(){const e=this.closest(".my-dropdown-item").querySelector(".my-dropdown-next-list");this.checked?e.style.display="flex":(e.style.display="none",e.querySelectorAll(".my-dropdown-item-checkbox").forEach(e=>{e.checked=!1}))}))}),document.addEventListener("click",(function(e){t.contains(e.target)||(s.style.display="none",r.style.display="none",i.classList.remove("active"),a(t))}))}}export{FileUploader,PhotoLoader,PhotoLoaderMini,PhoneInputManager,RealEstateDescriptionGenerator,GoogleMapsManager,RowManager,RowManagerDevelopers};