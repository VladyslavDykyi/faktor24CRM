<!doctype html>
<html lang="en">
<head>
	<meta charset="UTF-8">
	<meta name="viewport"
		  content="width=device-width, user-scalable=no, initial-scale=1.0, maximum-scale=1.0, minimum-scale=1.0">
	<meta http-equiv="X-UA-Compatible" content="ie=edge">
	<title>Page-home</title>
	<link rel="shortcut icon" href="./img/favicon.ico" type="image/x-icon">
	<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
	<link rel="stylesheet" href="https://unpkg.com/leaflet-draw@1.0.4/dist/leaflet.draw.css" />
	<link rel="stylesheet" href="./css/lib/select2.min.css">
	<link rel="stylesheet" href="./css/lib/bootstrap.v5.3.3.min.css">
	<link rel="stylesheet" href="./css/lib/data-range-picker.min.css">
	<link rel="stylesheet" href="./css/pages/page-geo-locations.min.css">
</head>
<body class="d-flex flex-column min-vh-100">
<main class="wrapper">
	<!-- початок side-bar	-->
	@@include('./html/_side-bar.html')
	<!-- кінець side-bar	-->
	<!-- початок main	-->
	@@include('./html/page-geo-locations/_page-geo-locations.html')
	<!-- кінець main	-->
</main>
<!-- початок цей блок ще в розробці _modal	-->
@@include('./html/_modal.html')
<!-- кінець цей блок ще в розробці _modal	-->
<script src="./js/lib/popper.v2.11.8.min.js"></script>
<script src="./js/lib/bootstrap.v5.3.3.min.js"></script>
<script src="./js/lib/jquery.v3.7.1.min.js"></script>
<script src="./js/lib/moment.min.js"></script>
<script src="./js/lib/data-range-picker.min.js"></script>
<script src="./js/lib/select2.min.js"></script>
<script src="./js/pages/filter1.min.js"></script>
<script src="./js/pages/full-filter.min.js"></script>
<script src="./js/pages/my-dropdown.min.js"></script>
<script src="./js/pages/page-geo-locations.min.js"></script>
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<!-- Підключаємо плагін для маркерів з текстом -->
<script src="https://unpkg.com/leaflet-text-icon@1.0.0/dist/leaflet.text-icon.js"></script>
<!-- Підключаємо плагін для редагування фігур -->
<script src="https://unpkg.com/leaflet-draw@1.0.4/dist/leaflet.draw.js"></script>
<script>
	function initMap() {
		// Ініціалізуємо карту
		let map = L.map('map').setView([46.4825, 30.7233], 12);
		
		L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
			attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors'
		}).addTo(map);
		
		// Масив маркерів
		let locations = [
			{ lat: 46.4775, lng: 30.7326, title: "агент 1", quantityOfObjects: '1', id:22 },
			{ lat: 46.4875, lng: 30.7426, title: "агент 2", quantityOfObjects: '5', id:23 },
			{ lat: 46.4825, lng: 30.7333, title: "агент 1", quantityOfObjects: '15', id:24 },
		];
		
		let markers = [];
		let circleGroup = null;
		
		// Функція для створення маркерів
		function createMarker(location) {
			const marker = L.marker([location.lat, location.lng], {
				title: location.title
			}).addTo(map);
			
			marker.bindPopup(`<b>${location.title}</b><br>Об'єктів: ${location.quantityOfObjects}`);
			
			markers.push(marker);
			return marker;
		}
		
		// Додаємо всі маркери
		locations.forEach(createMarker);
		
		// Функція для фільтрації маркерів
		function filterMarkers() {
			if (!circleGroup || !circleGroup.circle) return;
			
			const center = circleGroup.circle.getLatLng();
			const radius = circleGroup.circle.getRadius();
			
			markers.forEach(marker => {
				const distance = center.distanceTo(marker.getLatLng());
				marker.setOpacity(distance <= radius ? 1 : 0.3);
			});
			
			updateResizeHandlePosition();
		}
		
		// Оновлення позиції кнопки зміни розміру
		function updateResizeHandlePosition() {
			if (!circleGroup) return;
			
			const center = circleGroup.circle.getLatLng();
			const radius = circleGroup.circle.getRadius();
			
			// Точніший розрахунок позиції на краю кола
			const angle = 0; // 0 градусів - праворуч
			const dx = radius * Math.cos(angle * Math.PI / 180);
			const dy = radius * Math.sin(angle * Math.PI / 180);
			
			// Конвертуємо метри в градуси (приблизно 111320 метрів у градусі)
			const dLng = dx / (111320 * Math.cos(center.lat * Math.PI / 180));
			const dLat = dy / 111320;
			
			const edgePoint = L.latLng(
				center.lat + dLat,
				center.lng + dLng
			);
			
			circleGroup.resizeHandle.setLatLng(edgePoint);
		}
		
		// Функція для створення круга з елементами управління
		function createCircleWithControls(center, radius) {
			// Основний круг
			const circle = L.circle(center, {
				radius: radius,
				color: '#3585F5',
				fillColor: '#3585F5',
				fillOpacity: 0.2,
				weight: 2
			}).addTo(map);
			
			// Розраховуємо точку на краю кола (праворуч)
			const edgePoint = L.latLng(
				center.lat,
				center.lng + (radius / 111320 * Math.cos(center.lat * Math.PI / 180))
			);
			
			// Кнопка зміни розміру (завжди видима на краю кола)
			const resizeHandle = L.marker(edgePoint, {
				icon: L.divIcon({
					className: 'resize-handle',
					html: '<div class="resize-button">↔</div>',
					iconSize: [30, 30]
				}),
				draggable: true,
				zIndexOffset: 1000
			}).addTo(map);
			
			// Центральний маркер для переміщення
			const centerHandle = L.marker(center, {
				icon: L.divIcon({
					className: 'center-handle',
					html: '<div class="move-button">⤡</div>',
					iconSize: [30, 30]
				}),
				draggable: true,
				zIndexOffset: 1000
			}).addTo(map);
			
			// Обробник перетягування кнопки зміни розміру
			resizeHandle.on('drag', function(e) {
				const newCenter = centerHandle.getLatLng();
				const newRadius = newCenter.distanceTo(e.target.getLatLng());
				circle.setRadius(newRadius);
				filterMarkers();
			});
			
			// Обробник перетягування центрального маркера
			centerHandle.on('drag', function(e) {
				const newCenter = e.target.getLatLng();
				circle.setLatLng(newCenter);
				centerHandle.setLatLng(newCenter);
				filterMarkers();
			});
			
			return {
				circle: circle,
				resizeHandle: resizeHandle,
				centerHandle: centerHandle,
				remove: function() {
					map.removeLayer(circle);
					map.removeLayer(resizeHandle);
					map.removeLayer(centerHandle);
				}
			};
		}
		
		// Стилі для елементів управління
		const style = document.createElement('style');
		style.textContent = `
            .resize-handle .resize-button {
                width: 30px;
                height: 30px;
                background-color: white;
                border: 3px solid #3585F5;
                border-radius: 50%;
                cursor: ew-resize;
                display: flex;
                align-items: center;
                justify-content: center;
                font-weight: bold;
                color: #3585F5;
                font-size: 14px;
                box-shadow: 0 0 5px rgba(0,0,0,0.3);
            }
            .center-handle .move-button {
                width: 30px;
                height: 30px;
                background-color: #3585F5;
                border: 2px solid white;
                border-radius: 50%;
                cursor: move;
                display: flex;
                align-items: center;
                justify-content: center;
                color: white;
                font-weight: bold;
                font-size: 14px;
                box-shadow: 0 0 5px rgba(0,0,0,0.3);
            }
        `;
		document.head.appendChild(style);
		
		// Кнопка для управління фільтром
		const filterBtn = document.createElement('button');
		filterBtn.textContent = 'Увімкнути фільтр по зоні';
		filterBtn.style.cssText = `
            position: absolute;
            top: 10px;
            left: 50%;
            transform: translateX(-50%);
            z-index: 1000;
            padding: 8px 16px;
            background: #3585F5;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 14px;
            box-shadow: 0 0 5px rgba(0,0,0,0.3);
        `;
		document.getElementById('map').appendChild(filterBtn);
		
		// Обробник кліку для кнопки фільтра
		filterBtn.addEventListener('click', function() {
			if (circleGroup) {
				circleGroup.remove();
				circleGroup = null;
				markers.forEach(marker => marker.setOpacity(1));
				filterBtn.textContent = 'Увімкнути фільтр по зоні';
			} else {
				circleGroup = createCircleWithControls(map.getCenter(), 1000);
				filterMarkers();
				filterBtn.textContent = 'Вимкнути фільтр по зоні';
			}
		});
	}
	
	document.addEventListener('DOMContentLoaded', initMap);
</script>




</body>
</html>